<!DOCTYPE html>
<html lang="en">
<head>
    <!-- layout logic from Bootstrap -->
    <link 
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" 
        rel="stylesheet" 
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" 
        crossorigin="anonymous">    
    <!-- animations for Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"crossorigin="anonymous"></script>

    <!-- Font and traffic monitoring from Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quattrocento+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Quattrocento:wght@400;700&display=swap" rel="stylesheet">
	
    <!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-VGPQVGX8VD"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-VGPQVGX8VD');
	</script>
    <link rel="icon" type="image/png" href="/favicon.png"/>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>FF4 Ultima Plus Patcher</title>
    <style>
body {
    font-family: "Quattrocento Sans", Arial, sans-serif;
    font-weight: 400;
    font-style: normal;
    color: #e4e4e6;
    background: palegoldenrod;
}
h1 {
    font-family: "Quattrocentro", serif;
}
h2 {
    font-family: "Quattrocentro", serif;
}
.file-upload {
    margin-bottom: 10px;
    background-color: black;
    color: white;
}

/* "Please Wait Donut" animation effect (throbbing annular) */

#spinner-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  visibility: hidden; /* Hidden on load */
  opacity: 0;
  transition: visibility 0s, opacity 0.3s ease-in-out;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 6px solid #f3f3f3;
  border-top: 6px solid orchid;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

#spinner-overlay.show {
  visibility: visible;
  opacity: 1;
}

/* button styling */

@keyframes guide-text {
  0% {color: #80a;}
  50% {color: #f0f;}
  100% {color: #80a;}
}
.lilytext {
  color: #80a;
  animation-name: guide-text;
  animation-duration: 3s;
  -moz-animation-duration: 3s;
  -webkit-animation-duration: 3s;
  animation-iteration-count: infinite;
  -moz-animation-iteration-count: infinite;
  -webkit-animation-iteration-count: infinite;
}


@keyframes apply-text {
  0% {color: white;}
  50% {color: red;}
  100% {color: white;}
}
.lfg-text {
  animation-name: apply-text;
  animation-duration: 2.5s;
  -moz-animation-duration: 2.5s;
  -webkit-animation-duration: 2.5s;
  animation-iteration-count: infinite;
  -moz-animation-iteration-count: infinite;
  -webkit-animation-iteration-count: infinite;
  background-color: #408;
}

#crc-display {
    margin-top: 6px;
    margin-bottom: 6px;
}

button {
  padding: 6px;
  border-radius: 10px;
  color: #999;
  background-color: #333;
}

input::file-selector-button {
  color: gold;
  background-color: #333;
  padding: 6px;
  border-radius: 10px;   
}

.highlight {
    font-weight: bold;
    background-color: white;
    border-radius: 3px;
    padding: 2px;
    color: blue;
}

/* adapted from https://stackoverflow.com/questions/23441060/how-to-animate-gradients-using-css */
#gradient
{
    height:100vh;
    width:100vw;
    background: linear-gradient(177deg,#408, #000, #408);
    background-size: 200% 200%;

    -webkit-animation: Animation 23s ease infinite;
    -moz-animation: Animation 23s ease infinite;
    animation: Animation 23s ease infinite;
}

@-webkit-keyframes Animation {
    0%{background-position:10% 0%}
    50%{background-position:91% 100%}
    100%{background-position:10% 0%}
}
@-moz-keyframes Animation {
    0%{background-position:10% 0%}
    50%{background-position:91% 100%}
    100%{background-position:10% 0%}
}
@keyframes Animation { 
    0%{background-position:10% 0%}
    50%{background-position:91% 100%}
    100%{background-position:10% 0%}
}
	</style>

	<!-- for unzipping archives -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>


</head>
<body id="gradient" style="font: 1rem 'Quattrocento Sans', sans-serif;">
    
    <!-- navbar inject -->
    <div id="navbar"></div>
    <script>
    fetch('navbar.html')
        .then(response => response.text())
        .then(html => {
        document.getElementById('navbar').innerHTML = html;
        });
    </script>
    
    <header class="container-fluid">
    <!-- first row, page title -->
    <div class="row justify-content-center">
        <!-- begins single column -->
        <div class="col d-flex justify-content-center">
            <h1 style="font-family: Quattrocento;">
                FF4 Ultima Plus Patcher
            </h1>
        </div>
    </div>
    </header>

	<!-- UX element that shows during download then is removed -->
	<div id="spinner-overlay" class="spinner-overlay">
		<div class="spinner"></div>
	</div>

    <main class="container-fluid">

		<hr/>

		<!-- 2nd row, first interaction -->
		<div class="row mx-auto" style="width: 87vw;">
			<!-- begins first column -->
			<div class="col-12 col-sm-6">

                <div class="col g-col-6">
                    <p>Upload a FFII or FF4J rom and this patcher will change it to FF4 Ultima Plus. If you have any trouble, reach out in the FF4 Ultima Discord!</p>
                    <!-- ROM Upload -->
                </div>
                <div class="file-upload col g-col-6">
                    <label for="rom">ROM File (.sfc or .smc):</label>
                    <input type="file" id="romUpload" accept=".sfc,.smc" />
                </div>

                <div>Valid CRC32 values:
                    <span class="possible-match">65D0A825</span>,
                    <span class="possible-match">23084FCD</span>,
                    <span class="possible-match">6CDA700C</span>,
                    <span class="possible-match">CAA15E97</span>,
                    <span class="possible-match">E73564DB</span>,
                    <span class="possible-match">A1ED8333</span>,
                    <span class="possible-match">EE3FBCF2</span>,
                    <span class="possible-match">48449269</span>
                </div>
                <div id="crc-display" style="color:gold; font-size:large;">Your rom's CRC: (waiting for upload...)</div>
                <div class="grid gap-0 column-gap-0">
                    <!-- dropdown of patches -->
                    <select id="patch-dropdown" style="display:none;">
                        <option value="" disabled selected>Select a patch</option>
                    </select>    
        
                    <button id="applyPatch" class="">Apply Patch</button>
                    <p>&nbsp;</p>
                    <p>Current version of Ultima Plus is 1.09</p>
                    <p>
                        <a target="_blank" href="https://github.com/jacksmedia/Ultima-Plus-Patchapp/blob/main/Final%20Fantasy%20IV%20Ultima%20Plus%20changelog.txt">
                            View Plus vs Classic changelog
                        </a>
                    </p>
                </div>

			</div>
			<div class="col-12 col-sm-6">
				<img src="./Title.png" 
				alt="preview of title screen of Final Fantasy 4 Ultima Plus" 
				style="width: 100%;"/>
			</div>
		</div>

		<hr/>

		<!-- 3rd row, optionals -->
        <div class="row">
            <div class="col-sm-6 d-flex justify-content-space-around align-items-center">

                <h5 style="color:#eff;">
                    If you want custom <span style="color:aqua;">graphics...</span>
                </h5>
                <!-- black btn styled div -->
                <a href="styles.html" style="text-decoration:none;">
                    <button class="d-flex justify-content-center align-items-center"
                    style="background: black; padding: 1rem; border-radius: 2rem;">
                        <h4 style="color:aqua;">
                            FF4 Ultima Plus Styles
                        </h4>
                    </button>
                </a>
            </div>

            <div class="col-sm-6 d-flex justify-content-space-around align-items-center">
                <h5 style="color:#eff;">
                    If you want custom <span style="color:tomato;">fonts...</span>
                </h5>
                <!-- black btn styled div -->
                <a href="fonts.html" style="text-decoration:none;">
                    <button class="d-flex justify-content-center align-items-center"
                    style="background: black; padding: 1rem; border-radius: 2rem;">
                        <h4 style="color:tomato;">
                            FF4 Ultima Plus Fonts
                        </h4>
                    </button>
                </a>
            </div>

            
        <!-- 4th row for Guides, Classic, and Discord link -->

            <div class="col-sm-4 d-flex align-items-center justify-content-center">
                <!-- black btn styled div -->
                <a href="guides.html" style="text-decoration:none;">
                <button class="d-flex justify-content-center align-items-center"
                style="background: black; padding: 1.2rem; border-radius: 2rem;">
                    <h4 class="lilytext">
                        FF4 Ultima Guides
                    </h4>
                </button>
                </a>		
            </div>
            


            <div class="col-sm-4 d-flex align-items-center justify-content-center">
                <p>If you want to play Ultima with RetroAchievements, find the <span style="color:palegoldenrod;">Classic Edition</span> here:</p>
                <!-- black btn styled div -->
                <a href="classic.html" style="text-decoration:none;">
                <button class="d-flex justify-content-center align-items-center"
                style="background: black; padding: 1.2rem; border-radius: 2rem;">
                    <span style="color:palegoldenrod; text-decoration:none;">
                        FF4 Ultima Classic
                    </span>
                </button>
                </a>
            </div>


            <div class="col-sm-4 d-flex justify-content-center align-items-center">			
                <!-- black btn styled link -->
                <a href="https://discord.gg/PGMASbSnD9" 
                target="_blank"
                style="text-decoration:none;">
                <button class="d-flex justify-content-center align-items-center"
                style="background: black; padding: 1rem; border-radius: 2rem;">
                    <h6 style="color: white;">Join us in
                    <span style="color:#f7dc6f;">
                        Ultima Discord
                    </h6>
                </button>
                </a>
            </div>

        </div>

        <hr/>

		<!-- 5th row, attribution -->
        <div class="row">
            <div class="col-sm-6">
                <p>FF4 Ultima Plus by <a href="http://ff4ultima.com/">8-bit fan</a> and Team Ultima Plus.</p>
                <p>This webapp coded by <a href="https://jacks.media">xJ4cks</a> & ChatGPT4-t.</p>
                <p>Final Fantasy IV by Squaresoft, 1991.<br/>Please obey all copyright laws and only use roms<br/>which you own the physical media of.</p>
            </div>

            <div class="col-sm-6 d-flex justify-content-center align-items-center">
                <p>You can also 
                <a href="Final Fantasy 4 Ultima Plus patch archive.zip">download all the patches</a> on this site.</p>
            </div>

        </div>
	</main>


<script>
let romData = null; // Stores the uploaded ROM file data
let zip = null; // Stores the loaded ZIP for later access

// Spinner UX Functions
function showSpinner() {
    const spinnerOverlay = document.getElementById('spinner-overlay');
    spinnerOverlay?.classList.add('show');
}

function hideSpinner() {
    const spinnerOverlay = document.getElementById('spinner-overlay');
    spinnerOverlay?.classList.remove('show');
}


// Accepted CRC32s for existing FF4UP patches
const romPatchMap = {
    "65D0A825": "ff2 v1.0.ips",
    "23084FCD": "ff2 v1.1.ips",
    "6CDA700C": "ffiv easy.ips",
    "CAA15E97": "ffiv rev1.1.ips",
    "E73564DB": "ff2 v1.0-H.ips",
    "A1ED8333": "ff2 v1.1-H.ips",
    "EE3FBCF2": "ffiv easy-H.ips",
    "48449269": "ffiv rev1.1-H.ips"
};

// Precomputes CRC32 Table (clever work by ChatpGPT4)
const crcTable = new Uint32Array(256);
for (let i = 0; i < 256; i++) {
    let crc = i;
    for (let j = 0; j < 8; j++) {
        crc = (crc & 1) ? (0xEDB88320 ^ (crc >>> 1)) : (crc >>> 1);
    }
    crcTable[i] = crc;
}

function computeCRC32(buffer) {
    let crc = 0xFFFFFFFF;
    for (let i = 0; i < buffer.length; i++) {
        let byte = buffer[i];
        crc = (crc >>> 8) ^ crcTable[(crc ^ byte) & 0xFF];
    }
    return (crc ^ 0xFFFFFFFF) >>> 0;
}

// UI magic, makes "Apply Patch" core-btn text change color when active
function textChange() {
    const button = document.getElementById('applyPatch');
    // Ensures styles are applied only as needed
    if (!button.classList.contains('lfg-text')) {
        button.classList.remove('core-btn');
        void button.offsetWidth; // Forces a repaint to trigger CSS animations
        button.classList.add('lfg-text');
        console.log("Apply Patch button activated!"); // Debugging
    }
}


// --UI magic--
// highlights entry in romPatchMap on match
// changes button styling
// changes display message
function crcHighlighter(crcHex) {
    console.log("Checking CRC:", crcHex);
    
    const crcElement = document.getElementById('crc-display');
    const button = document.getElementById('applyPatch');
    const spans = document.querySelectorAll('.possible-match');

    // general layout test
    if (!crcElement || !button) {
        console.error('One or more required UI elements not found.');
        return;
    }

    // Update CRC text display
    crcElement.textContent = `Your rom's CRC: ${crcHex}`;

    let matchFound = false;

    spans.forEach(span => {
        const spanText = span.textContent.trim().toUpperCase();

        if (spanText === crcHex.toUpperCase()) {
            console.log("Match found! Applying highlight.");
            span.classList.remove('highlight'); // Clear previous just in case
            void span.offsetWidth; // Forces a repaint
            span.classList.add('highlight');

            button.classList.add('lfg-text'); // Main feature active now
            matchFound = true;
        } else {
            span.classList.remove('highlight');
        }
    });

    if (!matchFound) {
        console.log("CRC not matched. Displaying invalid rom msg.")
        crcElement.textContent = `This rom won't work with this patcher. Try another!`;
        button.classList.remove('lfg-text'); // Rolls back activation styling
    }
}

// Handles ROM Upload & CRC Calculation
document.getElementById('romUpload').addEventListener('change', async (event) => {
    let file = event.target.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = function (e) {
        romData = new Uint8Array(e.target.result); // Use global `romData`
        let crc = computeCRC32(romData);
        let crcHex = crc.toString(16).toUpperCase();
        console.log("Computed CRC32:", crcHex);
        crcHighlighter(crcHex); // updates webapp

        // Auto-select matching patch
        if (romPatchMap[crcHex]) {
            const patchDropdown = document.getElementById('patch-dropdown');
            for (let option of patchDropdown.options) {
                if (option.value === romPatchMap[crcHex]) {
                    option.selected = true;
                    console.log(`Auto-selected patch: ${option.value}`);
                    break;
                }
            }
        }
    };
    reader.readAsArrayBuffer(file);
});

async function applyIpsPatch(romData, ipsData) {
    const IPS_HEADER = "PATCH";
    const IPS_FOOTER = "EOF";

    let offset = 0;

    // Shows spinner at the start
    showSpinner();

    try {
        // Verifies header
        const header = new TextDecoder().decode(ipsData.slice(0, 5));
        if (header !== IPS_HEADER) throw new Error("Invalid IPS file: Incorrect header.");
        offset += 5;

        while (offset < ipsData.length) {
            // Checks for footer
            if (offset + 3 <= ipsData.length) {
                const footer = new TextDecoder().decode(ipsData.slice(offset, offset + 3));
                if (footer === IPS_FOOTER) {
                    // Valid footer, end of process
                    return romData;
                }
            }

            // Reads patch address
            if (offset + 3 > ipsData.length) throw new Error("Invalid IPS file: Unexpected end of data while reading address.");
            const address = (ipsData[offset] << 16) | (ipsData[offset + 1] << 8) | ipsData[offset + 2];
            offset += 3;

            // Reads patch size
            if (offset + 2 > ipsData.length) throw new Error("Invalid IPS file: Unexpected end of data while reading size.");
            const size = (ipsData[offset] << 8) | ipsData[offset + 1];
            offset += 2;

            if (size === 0) {
                // RLE (Run Length Encoding)
                if (offset + 3 > ipsData.length) throw new Error("Invalid IPS file: Unexpected end of data in RLE encoding.");
                const rleSize = (ipsData[offset] << 8) | ipsData[offset + 1];
                const value = ipsData[offset + 2];
                offset += 3;

                // Checks and expands ROM size if necessary
                const endAddress = address + rleSize;
                if (endAddress > romData.length) {
                    console.warn(`Expanding ROM size to accommodate address: ${endAddress}`);
                    const expandedRom = new Uint8Array(endAddress);
                    expandedRom.set(romData);
                    romData = expandedRom;
                }

                // Applies RLE to ROM data
                for (let i = 0; i < rleSize; i++) {
                    romData[address + i] = value;
                }
            } else {
                // Normal patch
                if (offset + size > ipsData.length) throw new Error("Invalid IPS file: Unexpected end of data in normal patch.");
                const patchData = ipsData.slice(offset, offset + size);
                offset += size;

                // Checks and expands ROM size if necessary
                const endAddress = address + size;
                if (endAddress > romData.length) {
                    console.warn(`Expanding ROM size to accommodate address: ${endAddress}`);
                    const expandedRom = new Uint8Array(endAddress);
                    expandedRom.set(romData);
                    romData = expandedRom;
                }

                // Apply patch to ROM data
                for (let i = 0; i < size; i++) {
                    romData[address + i] = patchData[i];
                }
            }
        }

        throw new Error("Invalid IPS file: Missing footer.");
    } finally {
        // Always hides spinner, whether successful or errored out
        hideSpinner();
    }
}

// Apply the Patch <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
async function applySelectedPatch() {
    if (!romData) {
        alert('Please upload a ROM file first!');
        return;
    }

    const patchDropdown = document.getElementById('patch-dropdown');
    const selectedPatch = patchDropdown.value;
    if (!selectedPatch) {
        alert('Please select a patch to apply!');
        return;
    }

    if (!zip) {
        alert('Patch archive not loaded yet!');
        return;
    }

    try {
        showSpinner();

        // Fetches the IPS file from ZIP
        const patchFile = zip.files[selectedPatch];
        if (!patchFile) {
            throw new Error('Patch file not found in ZIP!');
        }

        const patchData = await patchFile.async('uint8array');

        // Employs bytecode changing logic
        const patchedRom = await applyIpsPatch(romData, patchData);
        console.log('Patch applied successfully.');

        // Downloads patched ROM
        downloadPatchedRom(patchedRom, 'FF4 Ultima Plus.sfc');
    } catch (error) {
        console.error('Error applying patch:', error);
        alert(`Error applying patch: ${error.message}`);
    } finally {
        hideSpinner();
    }
}
// <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

// Download the patched ROM
function downloadPatchedRom(data, filename) {
    const blob = new Blob([data], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.click();

    URL.revokeObjectURL(url);
    console.log('Patched ROM downloaded as:', filename);
}

// Load IPS Patch ZIP File
async function loadLocalZip() {
    const zipFilePath = 'FF4UP.zip';
    try {
        const response = await fetch(zipFilePath);
        if (!response.ok) {
            throw new Error(`Failed to fetch ZIP file: ${response.statusText}`);
        }

        const zipBlob = await response.blob();
        zip = await JSZip.loadAsync(zipBlob);

        console.log('ZIP file loaded successfully:', zip);

        // Extract `.ips` files from ZIP
        const patchFiles = Object.keys(zip.files).filter(relativePath =>
            relativePath.endsWith('.ips') && !zip.files[relativePath].dir
        );

        console.log('Filtered patch files:', patchFiles);
        populateDropdown(patchFiles);
    } catch (error) {
        console.error('Error loading ZIP file:', error);
    }
}

// Populate the Dropdown with Patch Files
function populateDropdown(patchFiles) {
    const patchDropdown = document.getElementById('patch-dropdown');
    if (!patchDropdown) {
        console.error('Dropdown element not found');
        return;
    }

    patchDropdown.innerHTML = ''; // Clear previous entries

    patchFiles.forEach(relativePath => {
        const option = document.createElement("option");
        option.value = relativePath;
        option.textContent = relativePath.split('/').pop();
        patchDropdown.appendChild(option);
        console.log('Added to dropdown:', relativePath);
    });

    console.log('Dropdown options populated:', patchDropdown.options.length);
}

// Initialize WebApp
document.addEventListener('DOMContentLoaded', () => {
    loadLocalZip();
    document.getElementById('applyPatch').addEventListener('click', applySelectedPatch);
});
</script>
        



</body>
  
</html>
